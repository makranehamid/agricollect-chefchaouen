<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriCollect Chefchaouen - Made by Makrane Hamid</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Outfit', 'sans-serif'] }, colors: { emerald: { 50: '#ecfdf5', 100: '#d1fae5', 500: '#10b981', 600: '#059669', 900: '#064e3b' } }, animation: { 'fade-in-up': 'fadeInUp 0.8s ease-out forwards', 'spin-slow': 'spin 3s linear infinite' }, keyframes: { fadeInUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } } } } }</script>
    <style>
        body {
            background-color: #f0fdf4;
            color: #1e293b;
            overflow-x: hidden
        }

        #loader {
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 9999;
            display: flex;
            flex-col: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease
        }

        #map {
            height: 650px;
            width: 100%;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            z-index: 1;
            border: 4px solid white
        }

        .gridjs-wrapper {
            border-radius: 1rem;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05)
        }

        .gridjs-head {
            background: transparent
        }

        .gridjs-th {
            background-color: #f8fafc !important;
            color: #64748b !important;
            font-weight: 700 !important;
            border: none !important;
            padding: 16px !important
        }

        .gridjs-td {
            border-bottom: 1px solid #f1f5f9 !important;
            padding: 14px !important;
            color: #334155
        }

        .leaflet-popup-content-wrapper {
            border-radius: 16px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1)
        }

        .leaflet-popup-content {
            margin: 0;
            width: 260px !important
        }

        .popup-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 16px;
            font-weight: 800;
            text-align: center;
            font-family: 'Outfit', sans-serif;
            font-size: 1.25rem
        }

        .popup-body {
            padding: 20px;
            background: white
        }

        .popup-img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 12px;
            margin-top: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1)
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5)
        }

        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1)
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)
        }
    </style>
</head>

<body class="p-4 md:p-8 font-sans">
    <div id="loader">
        <div class="relative w-24 h-24 mb-4">
            <div class="absolute inset-0 border-4 border-emerald-100 rounded-full animate-ping"></div>
            <div class="absolute inset-0 border-4 border-emerald-500 rounded-full border-t-transparent animate-spin">
            </div>
            <div class="absolute inset-0 flex items-center justify-center text-3xl">ðŸŒ±</div>
        </div>
        <h2 class="text-2xl font-black text-emerald-800 font-display animate-pulse">AgriCollect</h2>
        <p class="text-emerald-500 text-sm font-medium">Chargement des parcelles...</p>
    </div>
    <div class="max-w-[1600px] mx-auto space-y-8 opacity-0 animate-fade-in-up" id="main-content">
        <header
            class="flex flex-col md:flex-row justify-between items-center gap-6 glass-card p-6 rounded-3xl shadow-sm">
            <div class="flex items-center gap-4">
                <div class="relative group">
                    <div
                        class="absolute -inset-1 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-2xl blur opacity-25 group-hover:opacity-100 transition duration-1000 group-hover:duration-200">
                    </div>
                    <img src="../icon.jpg" alt="Logo App"
                        class="relative w-16 h-16 rounded-2xl shadow-xl object-cover ring-2 ring-white transform transition duration-500 hover:scale-105">
                </div>
                <div>
                    <h1 class="text-4xl font-black text-slate-800 font-display tracking-tight">AgriCollect</h1>
                    <h2 class="text-xl font-bold text-emerald-600 font-display tracking-wide uppercase">Chefchaouen</h2>
                    <p class="text-xs text-slate-400 font-medium mt-1">Made by Makrane Hamid</p>
                </div>
            </div>
            <div class="flex gap-3"><button id="toggle-map"
                    class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 px-5 py-3 rounded-xl font-bold transition flex items-center gap-2 shadow-sm"><svg
                        class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg><span>Vue Plan</span></button>
                <button onclick="showDebug()"
                    class="bg-slate-200 hover:bg-slate-300 text-slate-600 p-3 rounded-xl font-bold transition shadow-sm"
                    title="Diagnostic DonnÃ©es">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
                <button onclick="location.reload()"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg shadow-emerald-200 flex items-center gap-2"><svg
                        class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                        </path>
                    </svg>Actualiser</button>
            </div>
        </header>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div
                class="stat-card bg-white p-6 rounded-3xl border border-emerald-100 shadow-sm relative overflow-hidden group">
                <div
                    class="absolute top-0 right-0 w-32 h-32 bg-emerald-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110">
                </div>
                <div class="relative z-10">
                    <p class="text-sm font-bold text-emerald-600 uppercase tracking-widest mb-1">Superficie Totale</p>
                    <div class="flex items-baseline gap-2">
                        <h3 class="text-4xl font-black text-slate-800 font-display" id="stat-surface">--</h3><span
                            class="text-lg font-bold text-slate-400">Ha</span>
                    </div>
                </div>
            </div>
            <div
                class="stat-card bg-white p-6 rounded-3xl border border-blue-100 shadow-sm relative overflow-hidden group">
                <div
                    class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110">
                </div>
                <div class="relative z-10">
                    <p class="text-sm font-bold text-blue-600 uppercase tracking-widest mb-1">Parcelles RecensÃ©es</p>
                    <h3 class="text-4xl font-black text-slate-800 font-display" id="stat-count">--</h3>
                </div>
            </div>
            <div
                class="stat-card bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-3xl shadow-lg shadow-emerald-200 relative overflow-hidden text-white group">
                <div
                    class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110">
                </div>
                <div class="relative z-10">
                    <p class="text-sm font-bold text-emerald-100 uppercase tracking-widest mb-1">Culture Dominante</p>
                    <h3 class="text-4xl font-black font-display truncate" id="stat-crop">--</h3>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 pb-12">
            <div class="xl:col-span-2 space-y-4">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-xl font-bold text-slate-700 flex items-center gap-2"><span
                            class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></span> Carte Interactive</h2>
                    <span class="text-xs font-bold text-slate-400 bg-white px-2 py-1 rounded-lg border">Google Maps
                        Satellite</span>
                </div>
                <div id="map"></div>
            </div>
            <div class="xl:col-span-1 space-y-4">
                <h2 class="text-xl font-bold text-slate-700 px-2">Derniers RelevÃ©s</h2>
                <div
                    class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden h-[650px] flex flex-col">
                    <div id="table-container" class="flex-1 overflow-auto"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
    <script>const API_URL = "https://script.google.com/macros/s/AKfycbxKqb5_sUmBOJYW5SNJypywFQ9_Ij4hxtm7jBTwRULX1jrpf7jpeX-j1ndjgYT8137xKA/exec"; const map = L.map('map').setView([35.17, -5.27], 11); const layers = { satellite: L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { attribution: 'Â© Google Satellite', maxZoom: 20 }), street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap', maxZoom: 19 }) }; let currentLayer = layers.satellite; currentLayer.addTo(map); let isSatellite = true; document.getElementById('toggle-map').addEventListener('click', function () { map.removeLayer(currentLayer); if (isSatellite) { currentLayer = layers.street; this.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0121 18.382V7.618a1 1 0 01-.553-.894L15 7m0 13V7"></path></svg> <span>Vue Satellite</span>` } else { currentLayer = layers.satellite; this.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <span>Vue Plan</span>` } this.classList.toggle('bg-slate-800'); this.classList.toggle('text-white'); currentLayer.addTo(map); isSatellite = !isSatellite }); async function showDebug() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                const last3 = data.slice(-3);

                let msg = "DIAGNOSTIC DONNÃ‰ES (3 derniers ajouts):\n\n";
                last3.forEach((d, i) => {
                    msg += `--- ID: ${d.id || '?'} ---\n`;
                    msg += `Culture: ${d.culture}\n`;
                    msg += `Polygone (Lgth): ${d.polygon ? d.polygon.length : 'MANQUANT / VIDE'}\n`;
                    msg += `Polygone (Raw): ${d.polygon ? d.polygon.substring(0, 50) + "..." : "undefined"}\n\n`;
                });
                msg += "SI 'MANQUANT / VIDE' : VÃ©rifiez la colonne 'Polygon' dans Google Sheet.\n";
                msg += "SI 'undefined' : Le script Google Apps ne renvoie pas la colonne.";
                alert(msg);
            } catch (e) { alert("Erreur connexion: " + e); }
        } function getDirectImgUrl(url) { if (!url || typeof url !== 'string') return null; let id = ""; if (url.includes("id=")) { id = url.split("id=")[1].split("&")[0] } else if (url.includes("/d/")) { id = url.split("/d/")[1].split("/")[0] } return id ? `https://lh3.googleusercontent.com/d/${id}=s800` : null } async function getCommuneName(lat, lng) { try { const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`); const data = await res.json(); return data.address.town || data.address.village || data.address.city || "Zone rurale" } catch (e) { return "Inconnue" } } function parseDate(dateStr) {
            if (!dateStr) return "-";
            // Try parsing as a standard date string first
            let date = new Date(dateStr);
            if (!isNaN(date.getTime())) {
                return date.toLocaleDateString("fr-FR");
            }

            // Handle DD/MM/YYYY format
            const parts = dateStr.split(/[T ]/)[0].split(/[-/]/);
            if (parts.length === 3) {
                // Check for YYYY-MM-DD or DD-MM-YYYY
                if (parts[0].length === 4) { // YYYY-MM-DD
                    date = new Date(parts[0], parts[1] - 1, parts[2]);
                } else { // DD-MM-YYYY or DD/MM/YYYY
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                }
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString("fr-FR");
                }
            }
            return dateStr; // Return original string if parsing fails
        } async function init() {
            try {
                const response = await fetch(API_URL); const data = await response.json(); document.getElementById('loader').style.opacity = '0'; setTimeout(() => document.getElementById('loader').remove(), 500); let totalSurf = 0; let cropCount = {}; data.forEach(d => { let s = parseFloat(d.superficieha); if (!isNaN(s)) totalSurf += s; let c = d.culture || "Inconnu"; cropCount[c] = (cropCount[c] || 0) + 1 }); let dominantCrop = Object.entries(cropCount).sort((a, b) => b[1] - a[1])[0]; document.getElementById('stat-surface').textContent = totalSurf.toFixed(2); document.getElementById('stat-count').textContent = data.length; document.getElementById('stat-crop').textContent = dominantCrop ? dominantCrop[0] : "Aucune"; data.forEach(item => { if (item.latitude && item.longitude) { const imgUrl = getDirectImgUrl(item.lienphoto); const lat = parseFloat(item.latitude); const lng = parseFloat(item.longitude); const popupContent = document.createElement('div'); popupContent.innerHTML = `<div class="popup-header">${item.culture || 'Culture'}</div><div class="popup-body"><div class="flex items-center gap-2 mb-2 text-slate-700"><span class="p-1 bg-emerald-100 rounded-lg text-emerald-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg></span><span class="font-display font-bold text-lg">${item.superficieha || 0} Ha</span></div><div class="flex items-center gap-2 text-slate-500 text-sm"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span id="loc-${item.id}">Chargement...</span></div>${imgUrl ? `<img src="${imgUrl}" class="popup-img">` : ''}</div>`; const marker = L.marker([lat, lng]).addTo(map).bindPopup(popupContent); marker.on('popupopen', async () => { const el = document.getElementById(`loc-${item.id}`); if (el && el.textContent === "Chargement...") { const city = await getCommuneName(lat, lng); el.textContent = city } }); if (item.polygon && typeof item.polygon === 'string' && item.polygon.startsWith('[')) { try { const polyPoints = JSON.parse(item.polygon); if (Array.isArray(polyPoints) && polyPoints.length > 2) { L.polygon(polyPoints, { color: '#F59E0B', weight: 3, fillColor: '#FCD34D', fillOpacity: 0.4, dashArray: '10, 5' }).addTo(map) } } catch (e) { console.warn("Erreur polygone ID " + item.id, e) } } } }); new gridjs.Grid({
                    columns: ["Date", "Culture", "Surf (Ha)", "Commune"],
                    data: data.map(i => [
                        parseDate(i.timestamp),
                        i.culture || "-",
                        i.superficieha || "0",
                        i.commune || "(En attente)"
                    ]),
                    search: true,
                    pagination: { limit: 10 },
                    style: { table: { 'font-size': '13px' } },
                    className: { table: 'w-full' }
                }).render(document.getElementById("table-container"));
            } catch (err) { console.error(err); }
        }
        init();
    </script>
</body>

</html>